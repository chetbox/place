<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Place</title>

    <link rel="icon" type="image/png" href="favicon.png" />

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/5.4.2/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/5.4.2/firebase-database.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>

    <!-- <script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.17"></script>

<style>
      * {
        font-family: 'Helvetica', sans-serif;
        font-weight: 100;
      }
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        max-width: 100%;
        margin: 0;
      }
      #content {
        max-width: 100%;
      }
      #content > * {
        margin-left: 32px;
        margin-right: 32px;
      }
      #palette {
        border: 1px solid #ddd;
        display: table;
        border-collapse: separate;
      }
      #palette .color {
        display: table-cell;
        width: 8vmin;
        height: 8vmin;
        cursor: pointer;
        transition: transform 200ms, box-shadow 200ms;
      }
      #palette .color.selected {
        box-shadow: 0 0 6px #777;
        transform: scale(1.25);
      }
      #canvas-container {
        max-width: 100%;
        overflow: auto;
        margin-left: 0;
        margin-right: 0;
      }
      #canvas {
        border: 1px solid #ddd;
        border-collapse: collapse;
        overflow: auto;
        table-layout: fixed;
        width: max-content;
        margin: 0 32px;
      }
      #canvas td {
        height: 10px;
        width: 10px;
        border-color: transparent;
        cursor: pointer;
        transition: transform 200ms, box-shadow 200ms;
      }
      #canvas td:hover {
        transform: scale(1.5);
        box-shadow: 0 0 6px #777;
      }
      .color {
        background-color: white;
      }
      .color.color-0 {
        background-color: #FFFFFF;
      }
      .color.color-1 {
        background-color: #E4E4E4;
      }
      .color.color-2 {
        background-color: #888888;
      }
      .color.color-3 {
        background-color: #222222;
      }
      .color.color-4 {
        background-color: #FFA7D1;
      }
      .color.color-5 {
        background-color: #E50000;
      }
      .color.color-6 {
        background-color: #E59500;
      }
      .color.color-7 {
        background-color: #A06A42;
      }
      .color.color-8 {
        background-color: #E5D900;
      }
      .color.color-9 {
        background-color: #94E044;
      }
      .color.color-A {
        background-color: #02BE01;
      }
      .color.color-B {
        background-color: #00D3DD;
      }
      .color.color-C {
        background-color: #0083C7;
      }
      .color.color-D {
        background-color: #0000EA;
      }
      .color.color-E {
        background-color: #CF6EE4;
      }
      .color.color-F {
        background-color: #820080;
      }
      #about {
        text-align: center;
        font-size: 0.8em;
      }
    </style>
  </head>
  <body>

    <div id="content">

      <p>Pick a color</p>

      <div id="palette">
        <span
          v-for="color in palette"
          @click="selected.color = color"
          :class="[isSelected(color) && 'selected', 'color', colorClass(color)]"></span>
      </div>

      <p>Click a pixel to change its color</p>

      <div id="canvas-container">
        <table id="canvas">
          <tbody>
              <tr v-for="(row, rowIndex) in canvas">
                <td
                  v-for="(cellColor, columnIndex) in row"
                  @click="setPixelColor(rowIndex, columnIndex, selected.color)"
                  :class="['color', colorClass(cellColor)]"></td>
              </tr>
          </tbody>
        </table>
      </div>

    </div>

    <p id="about">
      Made with &#x2764; by <a href="https://chetbox.com">chetbox</a>
      <br />
      inspired by <a href="https://www.youtube.com/watch?v=_OTUGVAEWCA">this video</a> and <a href="http://reddit.com/place">Reddit Place</a>
      <br />
      <br />
      <a href="https://github.com/chetbox/place">Fork me on GitHub</a>
    </p>

    <script>
      function flatten(nested, flattened, xOffsets, yOffsets) {
        flattened = flattened || [];
        xOffsets = xOffsets || '';
        yOffsets = yOffsets || '';
        Object.keys(nested || {}).forEach(function(key) {
          const value = nested[key];
          if (typeof(value) === 'object') {
            flatten(value, flattened, xOffsets + key[0], yOffsets + key[1]);
          } else {
            // parse binary
            const x = parseInt(xOffsets + key[0], 2);
            const y = parseInt(yOffsets + key[1], 2);
            flattened[x][y] = value;
          }
        });
        return flattened;
      }

      function nestedDepth(nested) {
        return typeof(nested) === 'object'
          ? Object.values(nested).reduce(function(depth, child) { return 1 + Math.max(depth, nestedDepth(child)); }, 0)
          : 0;
      }

      function emptyCanvas(depth) {
        return [...Array(depth).keys()].map(() => Array(depth));
      }

      const viewModel = new Vue({
        el: '#content',
        data: {
          canvas: [],
          canvasDepth: 4,
          palette: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 15],
          selected: {
            color: 1,
          }
        },
        methods: {
          setPixelColor: function(row, column, color) {
            const xOffsets = row.toString(2).padStart(this.canvasDepth, '0');
            const yOffsets = column.toString(2).padStart(this.canvasDepth, '0');
            let pixelRef = this.canvasRef;
            for (let i=0; i<this.canvasDepth; i++) {
              pixelRef = pixelRef.child(xOffsets[i] + yOffsets[i]);
            }
            pixelRef.set(color);
          },
          isSelected(color) {
            return this.selected.color === color;
          },
          colorClass(colorInt) {
            return colorInt !== undefined && 'color-' + colorInt.toString(16).toUpperCase();
          },
        }
      });
      viewModel.db = null;
      viewModel.canvasRef = null;

      const canvasId = 'the-one-and-only';

      document.addEventListener('DOMContentLoaded', function() {
        const db = firebase.app().database();
        viewModel.db = db;

        const placeRef = db.ref('canvas').child(canvasId);
        viewModel.canvasRef = placeRef.child('canvas');

        placeRef.on('value', function(snapshot) {
          if (!snapshot.exists()) {
            console.warning('Canvas does not exist', canvasId);
            return;
          }
          const depth = snapshot.val().depth;
          const canvas = flatten(snapshot.val().canvas, emptyCanvas(Math.pow(2, depth)));
          Vue.set(viewModel, 'canvasDepth', depth);
          Vue.set(viewModel, 'canvas', canvas);
        });
      });
    </script>
  </body>
</html>
